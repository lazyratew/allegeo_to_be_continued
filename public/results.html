<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Allergy Results</title>
  <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/results.css">
</head>

<body>
  <nav>
    <div class="nav-title">
      <img src="images/allegeo_shiny.png" alt="Allegeo Logo" class="allegeo-logo">
    </div>
    <a href="contact.html" class="nav-icon" title="Contact Us">
      <img src="images/contact_icon.png" alt="Contact Us" class="contact-logo"
        style="height:48px;width:auto;margin-right:12px;vertical-align:middle;">
    </a>
    <a href="login.html" class="nav-icon" title="Logout">
      onclick="localStorage.removeItem('allergies'); sessionStorage.removeItem('allergies');">
      <img src="images/logout_shiny.png" alt="Logout" class="logout-logo">
    </a>
  </nav>
  <div class="main">
    <h1>Your Flagged Allergies</h1>
    <div class="results-section" id="resultsSection">
      <ul class="flagged-list" id="flaggedList">
        <!-- Flagged allergies will be injected here by JS -->
      </ul>
      <div class="no-flags" id="noFlags" style="display:none;">No flagged allergies detected! üéâ</div>
    </div>
  </div>
  <div class="bottom-nav">
    <a href="profile.html" class="nav-item" title="Profile">
      <span class="icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <circle cx="12" cy="8" r="4.5" fill="#FFD36E" stroke="#5e0818" stroke-width="1.5" />
          <path d="M4.5 20c0-3.59 3.13-6.5 7-6.5s7 2.91 7 6.5" fill="#B6E2D3" stroke="#5e0818" stroke-width="1.5"
            stroke-linecap="round" />
        </svg>
      </span>
      <span class="nav-label">Profile</span>
    </a>
    <a href="compare.html" class="nav-item" title="Compare">
      <span class="icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <circle cx="11" cy="11" r="7" fill="#F9A1BC" stroke="#5e0818" stroke-width="1.5" />
          <path d="M20 20l-3.5-3.5" stroke="#5e0818" stroke-width="1.5" stroke-linecap="round" />
          <circle cx="11" cy="11" r="4" fill="#FFF" fill-opacity="0.5" />
        </svg>
      </span>
      <span class="nav-label">Compare</span>
    </a>
    <a href="scan_page.html" class="nav-item" title="Scan">
      <span class="icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <rect x="3" y="7" width="18" height="10" rx="2" fill="#B6E2D3" stroke="#5e0818" stroke-width="1.5" />
          <rect x="7" y="11" width="10" height="2" rx="1" fill="#FFD36E" />
        </svg>
      </span>
      <span class="nav-label">Scan</span>
    </a>
    <a href="feedback.html" class="nav-item" title="Feedback">
      <span class="icon">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none">
          <path d="M4 19v-2.5A2.5 2.5 0 0 1 6.5 14h11A2.5 2.5 0 0 1 20 16.5V19" fill="#FFD36E" stroke="#5e0818"
            stroke-width="1.5" stroke-linecap="round" />
          <circle cx="12" cy="8" r="4" fill="#F9A1BC" stroke="#5e0818" stroke-width="1.5" />
        </svg>
      </span>
      <span class="nav-label">Feedback</span>
    </a>
  </div>

  <script>
    const BACKEND_URL = "https://allegeo-to-be-continued.onrender.com"
    function getSeverityClass(severity) {
      if (!severity) return '';
      const s = severity.toLowerCase();
      if (s === 'severe') return 'severe';
      if (s === 'moderate') return 'moderate';
      if (s === 'mild') return 'mild';
      return '';
    }

    function formatDate(ts) {
      const d = new Date(ts);
      return d.toLocaleString(undefined, { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }

    async function renderFlaggedAllergies() {
      const list = document.getElementById('flaggedList');
      const noFlags = document.getElementById('noFlags');
      list.innerHTML = '';
      noFlags.style.display = 'none'; // Initially hide this message

      try {
        // Fetch data from the new server endpoint
        const response = await fetch(`${BACKEND_URL}/products/getDetectionResults`, {
          credentials: "include"
        });

        if (response.status === 401) {
          // This is expected during logout/session timeout. 
          console.warn('User is logged out or session expired. Stopping result render.');
          document.getElementById('flaggedList').innerHTML = '';
          return;
        }
        if (!response.ok) throw new Error('Failed to fetch results with status: ' + response.status);

        const results = await response.json();

        if (results.length === 0) {
          noFlags.style.display = '';
          return;
        }

        results.forEach(result => {
          // Assuming result.products is an array and we want the first item
          const product = result.products[0];
          if (!product) return;

          const metaRow = document.createElement('div');
          metaRow.style = 'display:flex;justify-content:space-between;align-items:center;margin:0.6rem 0;font-size:0.95rem;color:#5e0818;';
          const left = document.createElement('div');
          if (product.name) left.innerHTML = `<strong style="color:#b07c1e;">${product.name}</strong>`;
          const right = document.createElement('div');
          right.style = 'color:#666;font-size:0.9rem;';
          right.textContent = formatDate(result.createdAt);
          metaRow.appendChild(left);
          metaRow.appendChild(right);
          list.appendChild(metaRow);

          (product.flaggedAllergens || []).forEach(item => {
            const li = document.createElement('li');
            li.className = 'flagged-item ' + getSeverityClass(item.severity);
            li.innerHTML = `
                        <span class="flagged-icon">‚ö†Ô∏è</span>
                        <div class="flagged-details">
                            <span class="flagged-allergen">${item.allergen}</span>
                            <span class="flagged-severity">${item.severity}</span>
                            <div class="flagged-source">Source: ${result.source || 'Unknown'} | Product: <span style='color:#b07c1e;'>${product.name}</span></div>
                        </div>
                    `;
            list.appendChild(li);
          });
        });

      } catch (err) {
        console.error("Error fetching results:", err);
        list.innerHTML = "<p>Failed to load results. Please try again later.</p>";
        noFlags.style.display = 'none';
      }
    }
    // Run on load
    renderFlaggedAllergies();
  </script>
</body>

</html>